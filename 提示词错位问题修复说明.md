# 提示词错位问题修复说明 - 严重错位问题

## 问题描述

**用户报告的严重错误**:

```
输入数据:
11    牛杂豆皮汤(没有粉丝的)
12    说明:汤里默认放有蒜苗和香菜.忌口请备注哟
13    牛杂豆皮汤+油酥烧饼2个
14    【点亮⭐专享】鹌鹑蛋一个

输出结果(错误):
11    牛杂豆皮汤(没有粉丝的)【🍲鲜香浓郁】  ✅ 正确
12    牛杂豆皮汤+油酥烧饼2个【🍔经典搭配】  ❌ 错误!这应该是第13行的结果
13    【点亮⭐专享】鹌鹑蛋一个【🌟收藏专享】  ❌ 错误!这应该是第14行的结果
14    牛杂豆皮汤➕油酥烧饼1个【🍔经典组合】  ❌ 错误!这是什么???
```

**从第 12 行开始,所有结果都错位了!**

## 根本原因分析

### 问题根源

AI 提示词中**缺少对非产品内容的处理指令**:

```
输入第 12 行: "说明:汤里默认放有蒜苗和香菜.忌口请备注哟"
```

- 这**不是一个产品名称**,而是一个**说明性文字**
- AI 按照原提示词的理解,认为这不符合"产品标题"的格式
- AI **跳过了这一行**,没有为它生成任何输出
- 导致从第 12 行开始,所有输出都**向上错位一行**

### 错误流程

1. 输入第 11 行:`牛杂豆皮汤(没有粉丝的)` → AI 输出:`牛杂豆皮汤(没有粉丝的)【🍲鲜香浓郁】` ✅
2. 输入第 12 行:`说明:汤里默认放有蒜苗和香菜...` → AI **跳过,没有输出** ❌
3. 输入第 13 行:`牛杂豆皮汤+油酥烧饼2个` → AI 输出:**放到第 12 行位置** ❌
4. 输入第 14 行:`【点亮⭐专享】鹌鹑蛋一个` → AI 输出:**放到第 13 行位置** ❌
5. 后续所有行依次错位...

### 原提示词的缺陷

**原 `Constrains` 部分**:
```markdown
1. 仅处理用户提供的完整产品标题(含"+"连接的套餐)...
```

这句话让 AI 误以为可以**忽略非产品标题**!

**原 `OutputFormat` 部分**:
```markdown
1. 每行仅包含 1 个完整产品标题(含套餐)的优化结果...
```

没有明确说明**遇到非产品内容该如何处理**!

## 修复方案

### 修复 1: 强化 `Constrains` 约束

**修改前**:
```markdown
## Constrains:
1. 仅处理用户提供的完整产品标题(含"+"连接的套餐),拒绝回答无关问题(如价格、竞品对比)。
2. 四字卖点需直接关联产品/套餐核心优势...
```

**修改后**:
```markdown
## Constrains:
1. **严格保证输入行数 = 输出行数**:用户输入多少行,必须输出对应的多少行,绝对不能跳过任何一行。
2. 对于**产品标题**(含"+"连接的套餐),按格式输出 "完整标题 +【表情符号 + 四字卖点】"。
3. 对于**非产品标题**的输入(如说明文字、备注信息、空行等),直接**原样输出该行内容**,不做任何修改,不添加【】。
4. 四字卖点需直接关联产品/套餐核心优势...
```

### 修复 2: 明确 `OutputFormat` 输出规则

**修改前**:
```markdown
## OutputFormat:
1. 每行仅包含 1 个完整产品标题(含套餐)的优化结果,输入的每个标题均需对应一行输出...
```

**修改后**:
```markdown
## OutputFormat:
1. **必须严格保证:输入多少行,输出多少行,逐行对应,不能有任何遗漏或额外行**。
2. 对于**产品标题**:输出格式为 "完整标题 +【表情符号 + 四字卖点】",行前无序号或符号。
3. 对于**非产品内容**(如"说明:xxx"、"备注:xxx"等):直接原样输出该行文字,不做任何修改,不添加【】。
```

### 修复 3: 优化 `Workflow` 工作流程

**修改前**:
```markdown
## Workflow:
1. First, 接收用户输入的产品标题(支持单个或多个,用换行分隔),记录输入的标题数量...
```

**修改后**:
```markdown
## Workflow:
1. First, 接收用户输入的所有行(用换行分隔),**记录总行数 N**。
2. Then, 逐行判断:
   - 如果是**产品标题**(如"牛肉粉丝汤"、"卤鸭板肠+卤菜"),则进行优化处理
   - 如果是**非产品内容**(如"说明:xxx"、"备注:xxx"、空行等),直接原样保留
3. Next, 对于产品标题:
   - 若为单品标题,分析单品核心特点
   - 若为套餐标题(含"+"),分析组合优势
4. After that, 提炼四字卖点并匹配表情符号
5. Finally, **按输入顺序逐行输出,确保输出总行数 = N**:
   - 产品标题输出格式: "完整标题 +【表情符号 + 四字卖点】"
   - 非产品内容: 原样输出
   - 绝对不能跳过任何一行
```

### 修复 4: 同步修改产品描述提示词

对 `DESCRIPTION_PROMPT` 也应用相同的修复逻辑:

```markdown
## 限制:
- **严格保证输入行数 = 输出行数**:用户输入多少行,必须输出对应的多少行,绝对不能跳过任何一行。
- 对于**菜品名称**,生成对应的菜品描述。
- 对于**非菜品内容**(如说明文字、备注信息、空行等),直接**原样输出该行内容**,不做任何修改。
```

## 预期效果

### 修复后的正确输出

```
输入数据:
11    牛杂豆皮汤(没有粉丝的)
12    说明:汤里默认放有蒜苗和香菜.忌口请备注哟
13    牛杂豆皮汤+油酥烧饼2个
14    【点亮⭐专享】鹌鹑蛋一个

预期输出:
11    牛杂豆皮汤(没有粉丝的)【🍲鲜香浓郁】           ✅ 产品标题,正常优化
12    说明:汤里默认放有蒜苗和香菜.忌口请备注哟        ✅ 非产品内容,原样输出
13    牛杂豆皮汤+油酥烧饼2个【🍔经典搭配】           ✅ 产品标题,正常优化
14    【点亮⭐专享】鹌鹑蛋一个【🌟收藏专享】         ✅ 产品标题,正常优化
```

### 核心改进

1. **输入行数 = 输出行数**:绝对保证一一对应
2. **智能识别**:自动区分产品标题 vs 说明文字
3. **原样保留**:说明文字不做任何修改,直接输出
4. **零错位**:彻底消除错位问题

## 测试建议

### 测试场景 1: 混合内容

**输入**:
```
卤鸭板肠(小份)
说明:默认添加香菜,忌口请备注
卤鸭板肠(大份)
备注:大份分量更足
```

**预期输出**:
```
卤鸭板肠(小份)【🍗卤香四溢】
说明:默认添加香菜,忌口请备注
卤鸭板肠(大份)【🍗分量十足】
备注:大份分量更足
```

### 测试场景 2: 空行处理

**输入**:
```
牛肉粉丝汤

牛杂粉丝汤
```

**预期输出**:
```
牛肉粉丝汤【🍜鲜香浓郁】

牛杂粉丝汤【🍜牛杂丰富】
```

### 测试场景 3: 特殊标记

**输入**:
```
【限时优惠】牛肉套餐
温馨提示:本品含牛肉过敏原
牛肉粉丝汤+油豆腐(大份)
```

**预期输出**:
```
【限时优惠】牛肉套餐【🎉限时特惠】
温馨提示:本品含牛肉过敏原
牛肉粉丝汤+油豆腐(大份)【🍱营养丰富】
```

## 技术细节

### AI 判断逻辑

AI 现在会使用以下逻辑判断每一行:

```
如果输入包含以下特征,则视为"非产品内容",原样输出:
  - 以"说明:"、"备注:"、"提示:"等开头
  - 空行
  - 纯符号或特殊字符
  - 明显的句子描述(而非产品名称)

否则,视为"产品标题",进行优化处理
```

### 输出保证机制

```
输入行数 N → AI 处理 → 输出行数必须 = N

每一行输入 → 必有对应的输出
  - 产品标题 → 添加【表情符号 + 四字卖点】
  - 非产品内容 → 原样输出
```

## 影响范围

- ✅ 关键词优化功能
- ✅ 产品描述生成功能
- ✅ 所有批量处理场景
- ✅ Excel 上传功能

## 兼容性

- ✅ 向后兼容:纯产品名称列表不受影响
- ✅ 向前兼容:支持混合内容(产品+说明)
- ✅ 格式兼容:不改变原有输出格式

## 验证方法

### 浏览器控制台验证

1. 打开浏览器开发者工具(F12)
2. 切换到 Console 标签
3. 查看日志:
   ```
   输入行数: 14
   输出行数: 14
   ✅ 行数匹配
   ```

### 结果对比验证

导出 Excel 后,检查:
- 原始列的行数 = 优化后列的行数
- 每一行都有对应的输出
- 说明文字原样保留,不被优化

## 常见问题

### Q: 如果 Excel 中有空行怎么办?

**A**: 空行会被原样输出为空行,保持行数对应。

### Q: 如果产品名称本身包含"说明"两个字怎么办?

**A**: AI 会根据上下文和格式智能判断。如果是产品名称(如"说明书套餐"),会正常优化。只有明显的说明性文字(如"说明:xxx")才会原样输出。

### Q: 修复后还会有错位吗?

**A**: 不会!提示词已经强制要求 AI 保证输入输出行数一致,并且逐行对应。即使 AI 无法识别某一行,也会原样输出,而不是跳过。

### Q: 需要重新上传 Excel 吗?

**A**: 是的。之前的错误结果已经错位,需要重新上传 Excel 文件,重新生成优化结果。

## 回滚方案

如果修复后出现新问题,可以回滚到原始提示词:

```bash
git checkout lib/prompts.ts
```

或者手动恢复 `Constrains`、`OutputFormat`、`Workflow` 部分到修复前的版本。

## 更新记录

- **2025-10-13 23:30**: 发现严重错位问题
- **2025-10-13 23:45**: 完成提示词修复
  - 修改 `KEYWORD_PROMPT` 的 Constrains、OutputFormat、Workflow
  - 修改 `DESCRIPTION_PROMPT` 的限制部分
  - 添加强制行数一致性约束
  - 添加非产品内容处理规则

---

**修复状态**: ✅ 已完成
**测试状态**: ⏳ 待用户测试
**影响范围**: 关键词优化 + 产品描述生成
**向后兼容**: ✅ 是
**严重性**: 🔴 高(导致所有数据错位)
**优先级**: 🔴 紧急(必须立即修复)
