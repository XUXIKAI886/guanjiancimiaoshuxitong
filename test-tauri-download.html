<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tauri ä¸‹è½½åŠŸèƒ½æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .section h2 {
            margin-top: 0;
            color: #667eea;
            font-size: 18px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
        }
        .status.success {
            background: #e8f5e9;
            color: #388e3c;
        }
        .status.warning {
            background: #fff3e0;
            color: #f57c00;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.05);
        }
        button:active {
            transform: scale(0.95);
        }
        #log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }
        canvas {
            border: 2px solid #ddd;
            border-radius: 5px;
            display: block;
            margin: 10px auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Tauri ä¸‹è½½åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>

        <!-- ç¯å¢ƒæ£€æµ‹ -->
        <div class="section">
            <h2>1ï¸âƒ£ ç¯å¢ƒæ£€æµ‹</h2>
            <div id="envStatus" class="status info">æ­£åœ¨æ£€æµ‹...</div>
            <button onclick="detectEnvironment()">ğŸ” é‡æ–°æ£€æµ‹ç¯å¢ƒ</button>
        </div>

        <!-- Dialog API æµ‹è¯• -->
        <div class="section">
            <h2>2ï¸âƒ£ Dialog API æµ‹è¯•</h2>
            <div id="dialogStatus" class="status info">ç‚¹å‡»æŒ‰é’®æµ‹è¯•ä¿å­˜å¯¹è¯æ¡†</div>
            <button onclick="testDialog()">ğŸ’¬ æµ‹è¯•ä¿å­˜å¯¹è¯æ¡†</button>
        </div>

        <!-- å›¾ç‰‡ä¸‹è½½æµ‹è¯• -->
        <div class="section">
            <h2>3ï¸âƒ£ å›¾ç‰‡ä¸‹è½½æµ‹è¯•</h2>
            <canvas id="testCanvas" width="400" height="200"></canvas>
            <button onclick="downloadTestImage()">ğŸ–¼ï¸ ä¸‹è½½æµ‹è¯•å›¾ç‰‡</button>
        </div>

        <!-- æ–‡æœ¬æ–‡ä»¶æµ‹è¯• -->
        <div class="section">
            <h2>4ï¸âƒ£ æ–‡æœ¬æ–‡ä»¶æµ‹è¯•</h2>
            <button onclick="downloadTestText()">ğŸ“„ ä¸‹è½½æµ‹è¯•æ–‡æœ¬</button>
        </div>

        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="section">
            <h2>ğŸ“Š æ§åˆ¶å°æ—¥å¿—</h2>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            <div id="log"></div>
        </div>
    </div>

    <script>
        // ========== æ—¥å¿—ç³»ç»Ÿ ==========
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º');
        }

        // ========== ç¯å¢ƒæ£€æµ‹ ==========
        function detectEnvironment() {
            log('å¼€å§‹æ£€æµ‹è¿è¡Œç¯å¢ƒ...');

            const isTauri = typeof window !== 'undefined' &&
                           typeof window.__TAURI__ !== 'undefined' &&
                           typeof window.__TAURI__.core !== 'undefined';

            const statusDiv = document.getElementById('envStatus');

            if (isTauri) {
                statusDiv.className = 'status success';
                statusDiv.textContent = 'âœ… æ£€æµ‹åˆ° Tauri ç¯å¢ƒï¼å¯¼å‡ºåŠŸèƒ½å°†ä½¿ç”¨ Tauri API';
                log('âœ… ç¯å¢ƒæ£€æµ‹: Tauri æ¡Œé¢åº”ç”¨');
                log('Tauri å¯¹è±¡: ' + JSON.stringify(Object.keys(window.__TAURI__)));
            } else {
                statusDiv.className = 'status warning';
                statusDiv.textContent = 'âš ï¸ æ£€æµ‹åˆ°æµè§ˆå™¨ç¯å¢ƒï¼å¯¼å‡ºåŠŸèƒ½å°†ä½¿ç”¨æµè§ˆå™¨ä¸‹è½½';
                log('âš ï¸ ç¯å¢ƒæ£€æµ‹: æµè§ˆå™¨ç¯å¢ƒ');
            }
        }

        // ========== Dialog API æµ‹è¯• ==========
        async function testDialog() {
            log('å¼€å§‹æµ‹è¯• Dialog API...');

            const isTauri = typeof window.__TAURI__ !== 'undefined';

            if (!isTauri) {
                alert('âŒ å½“å‰åœ¨æµè§ˆå™¨ç¯å¢ƒï¼Œæ— æ³•æµ‹è¯• Tauri Dialog API');
                log('âŒ æµ‹è¯•å¤±è´¥: ä¸åœ¨ Tauri ç¯å¢ƒä¸­');
                return;
            }

            try {
                const filePath = await window.__TAURI__.core.invoke('plugin:dialog|save', {
                    options: {
                        defaultPath: 'test-file.txt',
                        title: 'æµ‹è¯•ä¿å­˜å¯¹è¯æ¡†',
                        filters: [{
                            name: 'æ–‡æœ¬æ–‡ä»¶',
                            extensions: ['txt']
                        }]
                    }
                });

                const statusDiv = document.getElementById('dialogStatus');

                if (filePath) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = 'âœ… Dialog API æ­£å¸¸ï¼ç”¨æˆ·é€‰æ‹©è·¯å¾„: ' + filePath;
                    log('âœ… Dialog API æµ‹è¯•æˆåŠŸ');
                    log('é€‰æ‹©çš„ä¿å­˜è·¯å¾„: ' + filePath);
                } else {
                    statusDiv.className = 'status warning';
                    statusDiv.textContent = 'âš ï¸ ç”¨æˆ·å–æ¶ˆäº†ä¿å­˜';
                    log('âš ï¸ ç”¨æˆ·å–æ¶ˆäº†ä¿å­˜å¯¹è¯æ¡†');
                }
            } catch (error) {
                document.getElementById('dialogStatus').className = 'status warning';
                document.getElementById('dialogStatus').textContent = 'âŒ Dialog API æµ‹è¯•å¤±è´¥: ' + error.message;
                log('âŒ Dialog API æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // ========== å›¾ç‰‡ä¸‹è½½åŠŸèƒ½ ==========
        async function downloadTestImage() {
            log('å¼€å§‹æµ‹è¯•å›¾ç‰‡ä¸‹è½½...');

            // 1. ç»˜åˆ¶æµ‹è¯•å›¾ç‰‡
            const canvas = document.getElementById('testCanvas');
            const ctx = canvas.getContext('2d');

            // èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 400, 200);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 400, 200);

            // æ–‡å­—
            ctx.fillStyle = 'white';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Tauri æµ‹è¯•å›¾ç‰‡', 200, 80);
            ctx.font = '16px Arial';
            ctx.fillText('æ—¶é—´: ' + new Date().toLocaleString(), 200, 120);

            // 2. è½¬æ¢ä¸º Data URL
            const dataUrl = canvas.toDataURL('image/png');
            log('å›¾ç‰‡å·²ç”Ÿæˆï¼Œå¤§å°: ' + Math.round(dataUrl.length / 1024) + ' KB');

            // 3. ç¯å¢ƒæ£€æµ‹
            const isTauri = typeof window.__TAURI__ !== 'undefined';

            if (!isTauri) {
                // æµè§ˆå™¨ç¯å¢ƒ
                log('[æµè§ˆå™¨] ä½¿ç”¨ä¼ ç»Ÿä¸‹è½½æ–¹æ³•');
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = 'test-image.png';
                link.click();
                log('âœ… [æµè§ˆå™¨] å›¾ç‰‡ä¸‹è½½è§¦å‘æˆåŠŸ');
                alert('å›¾ç‰‡ä¸‹è½½å·²è§¦å‘ï¼ˆæµè§ˆå™¨ç¯å¢ƒï¼‰');
                return;
            }

            // Tauri ç¯å¢ƒ
            try {
                log('[Tauri] å¼€å§‹ä½¿ç”¨ Tauri API ä¿å­˜å›¾ç‰‡');

                // æ˜¾ç¤ºä¿å­˜å¯¹è¯æ¡†
                const filePath = await window.__TAURI__.core.invoke('plugin:dialog|save', {
                    options: {
                        defaultPath: 'test-image.png',
                        title: 'ä¿å­˜æµ‹è¯•å›¾ç‰‡',
                        filters: [{
                            name: 'å›¾ç‰‡æ–‡ä»¶',
                            extensions: ['png', 'jpg', 'jpeg']
                        }]
                    }
                });

                if (!filePath) {
                    log('âš ï¸ [Tauri] ç”¨æˆ·å–æ¶ˆäº†ä¿å­˜');
                    return;
                }

                log('[Tauri] ç”¨æˆ·é€‰æ‹©è·¯å¾„: ' + filePath);

                // è½¬æ¢ Base64 ä¸ºå­—èŠ‚æ•°ç»„
                const base64Data = dataUrl.split(',')[1];
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                log('[Tauri] å‡†å¤‡å†™å…¥æ–‡ä»¶ï¼Œå¤§å°: ' + bytes.length + ' bytes');

                // å†™å…¥æ–‡ä»¶
                await window.__TAURI__.core.invoke(
                    'plugin:fs|write_file',
                    bytes,
                    {
                        headers: {
                            path: encodeURIComponent(filePath),
                            options: JSON.stringify({})
                        }
                    }
                );

                log('âœ… [Tauri] å›¾ç‰‡ä¿å­˜æˆåŠŸï¼');
                alert('å›¾ç‰‡ä¿å­˜æˆåŠŸï¼\nä½ç½®: ' + filePath);

            } catch (error) {
                log('âŒ [Tauri] ä¿å­˜å¤±è´¥: ' + error.message);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // ========== æ–‡æœ¬æ–‡ä»¶ä¸‹è½½åŠŸèƒ½ ==========
        async function downloadTestText() {
            log('å¼€å§‹æµ‹è¯•æ–‡æœ¬æ–‡ä»¶ä¸‹è½½...');

            const textContent = `Tauri ä¸‹è½½åŠŸèƒ½æµ‹è¯•æ–‡ä»¶
ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}
ç¯å¢ƒ: ${typeof window.__TAURI__ !== 'undefined' ? 'Tauri æ¡Œé¢åº”ç”¨' : 'æµè§ˆå™¨'}

è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æœ¬æ–‡ä»¶ï¼Œç”¨äºéªŒè¯ Tauri æ–‡ä»¶ä¸‹è½½åŠŸèƒ½ã€‚

âœ… å¦‚æœä½ èƒ½çœ‹åˆ°è¿™ä¸ªæ–‡ä»¶ï¼Œè¯´æ˜ä¸‹è½½åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼
`;

            const isTauri = typeof window.__TAURI__ !== 'undefined';

            if (!isTauri) {
                // æµè§ˆå™¨ç¯å¢ƒ
                log('[æµè§ˆå™¨] ä½¿ç”¨ä¼ ç»Ÿä¸‹è½½æ–¹æ³•');
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'test-file.txt';
                link.click();
                URL.revokeObjectURL(url);
                log('âœ… [æµè§ˆå™¨] æ–‡ä»¶ä¸‹è½½è§¦å‘æˆåŠŸ');
                alert('æ–‡ä»¶ä¸‹è½½å·²è§¦å‘ï¼ˆæµè§ˆå™¨ç¯å¢ƒï¼‰');
                return;
            }

            // Tauri ç¯å¢ƒ
            try {
                log('[Tauri] å¼€å§‹ä½¿ç”¨ Tauri API ä¿å­˜æ–‡ä»¶');

                const filePath = await window.__TAURI__.core.invoke('plugin:dialog|save', {
                    options: {
                        defaultPath: 'test-file.txt',
                        title: 'ä¿å­˜æµ‹è¯•æ–‡æœ¬',
                        filters: [{
                            name: 'æ–‡æœ¬æ–‡ä»¶',
                            extensions: ['txt']
                        }]
                    }
                });

                if (!filePath) {
                    log('âš ï¸ [Tauri] ç”¨æˆ·å–æ¶ˆäº†ä¿å­˜');
                    return;
                }

                log('[Tauri] ç”¨æˆ·é€‰æ‹©è·¯å¾„: ' + filePath);

                const encoder = new TextEncoder();
                const bytes = encoder.encode(textContent);

                log('[Tauri] å‡†å¤‡å†™å…¥æ–‡ä»¶ï¼Œå¤§å°: ' + bytes.length + ' bytes');

                await window.__TAURI__.core.invoke(
                    'plugin:fs|write_file',
                    bytes,
                    {
                        headers: {
                            path: encodeURIComponent(filePath),
                            options: JSON.stringify({})
                        }
                    }
                );

                log('âœ… [Tauri] æ–‡ä»¶ä¿å­˜æˆåŠŸï¼');
                alert('æ–‡ä»¶ä¿å­˜æˆåŠŸï¼\nä½ç½®: ' + filePath);

            } catch (error) {
                log('âŒ [Tauri] ä¿å­˜å¤±è´¥: ' + error.message);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // ========== é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ ==========
        window.addEventListener('DOMContentLoaded', () => {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            detectEnvironment();

            // ç»˜åˆ¶åˆå§‹æµ‹è¯•å›¾ç‰‡
            const canvas = document.getElementById('testCanvas');
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 400, 200);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 400, 200);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ç‚¹å‡»æŒ‰é’®ä¸‹è½½æµ‹è¯•å›¾ç‰‡', 200, 100);
        });
    </script>
</body>
</html>
