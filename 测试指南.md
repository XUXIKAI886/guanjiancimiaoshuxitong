# 🧪 Tauri 导出功能测试指南

## 📋 测试前准备

### 1. 环境要求

**浏览器测试**:
- Chrome/Edge/Firefox 最新版本
- 已允许浏览器下载权限

**Tauri 测试**:
- 呈尚策划工具箱 v1.0.26+
- 已配置 Tauri dialog 和 fs 插件权限

### 2. 启动项目

```bash
# 开发模式
npm run dev

# 或生产模式
npm run build
npm start
```

---

## 🔍 测试方案 A: 使用测试页面（推荐）

### 步骤 1: 打开测试页面

**浏览器环境**:
```bash
# 直接打开
open test-tauri-download.html

# 或通过浏览器
http://localhost:3000/test-tauri-download.html
```

**Tauri 环境**:
在呈尚策划工具箱中加载 `test-tauri-download.html` 文件

### 步骤 2: 环境检测测试

✅ **预期结果 (浏览器)**:
```
⚠️ 检测到浏览器环境！导出功能将使用浏览器下载
```

✅ **预期结果 (Tauri)**:
```
✅ 检测到 Tauri 环境！导出功能将使用 Tauri API
```

### 步骤 3: Dialog API 测试（仅 Tauri）

1. 点击 "💬 测试保存对话框" 按钮
2. 应弹出文件保存对话框
3. 选择任意位置并输入文件名
4. 点击"保存"

✅ **预期结果**:
```
✅ Dialog API 正常！用户选择路径: C:\Users\...\test-file.txt
```

❌ **如果失败**: 检查 Tauri 配置是否启用 dialog 插件

### 步骤 4: 图片下载测试

1. 点击 "🖼️ 下载测试图片" 按钮

**浏览器环境**:
- 图片应自动下载到浏览器默认下载目录
- 文件名: `test-image.png`

**Tauri 环境**:
- 应弹出保存对话框
- 选择保存位置
- 保存成功后显示提示: "图片保存成功！位置: ..."

✅ **验证**: 打开保存的图片，应显示紫色渐变背景和测试文字

### 步骤 5: 文本文件下载测试

1. 点击 "📄 下载测试文本" 按钮

**浏览器环境**:
- 文件应自动下载
- 文件名: `test-file.txt`

**Tauri 环境**:
- 应弹出保存对话框
- 选择保存位置
- 保存成功后显示提示

✅ **验证**: 打开文本文件，应包含完整的测试内容

### 步骤 6: 查看日志

测试页面的"控制台日志"区域会显示所有操作的详细日志：
- `[浏览器]` 前缀 = 浏览器环境日志
- `[Tauri]` 前缀 = Tauri 环境日志
- ✅ = 成功操作
- ⚠️ = 警告
- ❌ = 错误

---

## 🎯 测试方案 B: 使用主应用

### 步骤 1: 准备测试数据

创建测试输入（关键词优化或描述生成）:

```
卤鸭板肠(小份)
柠檬茶(大杯)
麻辣小龙虾
招牌烤鱼
椒盐排骨
```

### 步骤 2: 生成优化结果

1. 访问 `http://localhost:3000`
2. 选择"关键词优化"或"产品描述生成"
3. 选择平台（美团/饿了么）
4. 输入测试数据
5. 点击"开始优化"或"开始生成"
6. 等待 AI 处理完成

### 步骤 3: 测试 Excel 导出

#### 浏览器环境测试

1. 点击 "📊 导出Excel" 按钮
2. 文件应自动下载到浏览器默认下载目录
3. 文件名格式: `关键词优化_20250112_143025.xlsx`

✅ **验证步骤**:
- 打开 Excel 文件
- 检查是否有表头: `原关键词 | 优化后关键词`
- 检查数据是否完整（行数匹配）
- 检查中文是否显示正常
- 检查列宽是否合适

#### Tauri 环境测试

1. 点击 "📊 导出Excel" 按钮
2. 应弹出文件保存对话框
3. 测试以下场景:
   - ✅ 保存到桌面
   - ✅ 保存到中文路径（如 `C:\用户\文档`）
   - ✅ 使用中文文件名（如 `测试数据.xlsx`）
   - ✅ 点击"取消"按钮（应无错误提示）
4. 选择保存位置并确认
5. 应显示成功提示: "Excel文件保存成功！保存位置: ..."

✅ **验证步骤**: 同浏览器环境

### 步骤 4: 测试图片导出

#### 浏览器环境测试

1. 点击 "🖼️ 导出图片" 按钮
2. 文件应自动下载
3. 文件名格式: `关键词优化_20250112_143025.jpg`

✅ **验证步骤**:
- 打开图片文件
- 检查表格是否完整显示
- 检查文字是否清晰
- 检查中文是否显示正常
- 检查表格边框和背景色

#### Tauri 环境测试

1. 点击 "🖼️ 导出图片" 按钮
2. 应弹出文件保存对话框
3. 测试以下场景:
   - ✅ 保存为 `.jpg` 格式
   - ✅ 保存为 `.png` 格式（修改文件扩展名）
   - ✅ 保存到中文路径
   - ✅ 使用中文文件名
   - ✅ 点击"取消"按钮
4. 选择保存位置并确认
5. 应显示成功提示: "图片保存成功！保存位置: ..."

✅ **验证步骤**: 同浏览器环境

### 步骤 5: 边界情况测试

#### 大数据量测试

1. 准备 100 条测试数据（复制粘贴）
2. 生成优化结果
3. 导出 Excel 和图片
4. 检查文件是否完整

✅ **预期**: 所有数据完整导出，无报错

#### 特殊字符测试

测试包含特殊字符的内容:
```
产品A (带括号)
产品B【带中文括号】
产品C + 套餐D
产品E&F
产品G|H
```

✅ **预期**: 特殊字符正常显示和导出

#### 长文本测试

测试超长产品名称（50+ 字符）

✅ **预期**: 图片导出时文字自动换行

---

## 📊 测试检查表

### 功能测试

- [ ] 环境自动检测正常
- [ ] 浏览器环境 Excel 导出正常
- [ ] 浏览器环境图片导出正常
- [ ] Tauri 环境 Excel 导出正常
- [ ] Tauri 环境图片导出正常
- [ ] 文件保存对话框正常弹出
- [ ] 用户取消保存时无错误
- [ ] 成功保存后显示提示信息

### 兼容性测试

- [ ] 中文路径保存成功
- [ ] 中文文件名保存成功
- [ ] 特殊字符处理正常
- [ ] 大数据量导出正常（100+条）
- [ ] 不同文件格式支持（xlsx/xls/jpg/png）

### 用户体验测试

- [ ] 导出按钮响应正常
- [ ] 文件保存对话框标题正确
- [ ] 默认文件名有意义
- [ ] 成功/失败提示清晰
- [ ] 控制台日志详细完整

### 错误处理测试

- [ ] 无数据时导出提示正常
- [ ] 网络错误时提示清晰
- [ ] 文件写入失败时提示正确
- [ ] 用户取消操作时无报错

---

## 🐛 常见问题排查

### 问题 1: 点击导出按钮没反应

**排查步骤**:
1. 打开浏览器控制台 (F12)
2. 切换到 Console 标签
3. 查看是否有错误信息
4. 检查是否有结果数据（results.length > 0）

**可能原因**:
- 没有生成结果数据
- JavaScript 错误
- Tauri API 未加载

### 问题 2: Tauri 环境下载对话框不弹出

**排查步骤**:
1. 控制台运行: `console.log(window.__TAURI__)`
2. 检查是否输出 `undefined`
3. 如果是 `undefined` = 不在 Tauri 环境中

**解决方案**:
- 确认在呈尚策划工具箱中运行
- 检查 Tauri 配置文件权限设置

### 问题 3: 文件保存后找不到

**排查步骤**:
1. 查看成功提示中的文件路径
2. 使用资源管理器导航到该路径
3. 检查文件是否存在

**可能原因**:
- 路径记录错误
- 文件被杀毒软件拦截
- 磁盘空间不足

### 问题 4: Excel 文件打开乱码

**原因**: 文件编码问题（不太可能，xlsx 是二进制格式）

**解决方案**:
- 使用最新版本的 Excel 或 WPS
- 确认文件扩展名为 `.xlsx`

### 问题 5: 图片显示不完整

**原因**: Canvas 尺寸计算错误

**解决方案**:
- 检查数据行数
- 如果超过 50 行，考虑分批导出

---

## 📝 测试报告模板

### 测试环境

- 测试日期: `2025-01-12`
- 操作系统: `Windows 11 / macOS`
- 浏览器: `Chrome 120 / Edge 120`
- Tauri 版本: `呈尚策划工具箱 v1.0.26+`

### 测试结果

| 测试项 | 浏览器环境 | Tauri 环境 | 备注 |
|--------|-----------|-----------|------|
| 环境检测 | ✅ 通过 | ✅ 通过 | |
| Excel 导出 | ✅ 通过 | ✅ 通过 | |
| 图片导出 | ✅ 通过 | ✅ 通过 | |
| 中文路径 | N/A | ✅ 通过 | |
| 特殊字符 | ✅ 通过 | ✅ 通过 | |
| 大数据量 | ✅ 通过 | ✅ 通过 | 测试 100 条 |
| 取消保存 | N/A | ✅ 通过 | 无报错 |

### 发现的问题

1. ❌ 问题描述
   - 复现步骤:
   - 预期结果:
   - 实际结果:
   - 错误日志:

### 测试结论

- [ ] ✅ 所有功能正常，可以发布
- [ ] ⚠️ 有小问题，需要修复后再测试
- [ ] ❌ 有严重问题，需要重新开发

---

## 🎓 调试技巧

### 1. 查看详细日志

所有导出函数都包含详细日志：

```javascript
// 打开控制台 (F12)
// 查看以下日志:
// [浏览器] 或 [Tauri] 开头的日志
// ✅ 成功操作
// ⚠️ 警告信息
// ❌ 错误信息
```

### 2. 手动测试 Tauri API

在 Tauri 环境的控制台中运行：

```javascript
// 测试 Dialog API
window.__TAURI__.core.invoke('plugin:dialog|save', {
  options: { defaultPath: 'test.txt' }
}).then(path => console.log('路径:', path));

// 测试 FS API
const encoder = new TextEncoder();
const bytes = encoder.encode('测试内容');
window.__TAURI__.core.invoke(
  'plugin:fs|write_file',
  bytes,
  {
    headers: {
      path: encodeURIComponent('C:\\Users\\Desktop\\test.txt'),
      options: JSON.stringify({})
    }
  }
).then(() => console.log('写入成功'));
```

### 3. 对比浏览器和 Tauri 日志

在两种环境中执行相同操作，对比日志输出：
- 浏览器应显示 `[浏览器]` 日志
- Tauri 应显示 `[Tauri]` 日志

---

## 📞 获取帮助

如果测试过程中遇到问题：

1. **查看文档**:
   - `Tauri集成说明.md` - 详细技术文档
   - `TAURI_DOWNLOAD_INTEGRATION_GUIDE.md` - Tauri API 使用指南

2. **检查日志**:
   - 浏览器控制台 (F12 → Console)
   - 查看详细的错误信息和调用栈

3. **参考案例**:
   - 美工系统: https://www.yujinkeji.xyz
   - 已成功集成 Tauri 下载功能

4. **提交 Issue**:
   - 包含详细的复现步骤
   - 附上控制台日志截图
   - 说明测试环境信息

---

**文档版本**: v1.0
**更新日期**: 2025-01-12
**维护者**: 项目开发团队
